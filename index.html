<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>AQ///BMW - تفعيلات BMW الحديثة</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* CSS الذي قدمته سابقاً */
        :root {
            --bmw-blue: #005792;
            --bmw-red: #d63031;
            --bmw-white: #ffffff;
            --bmw-gray: #f4f4f4;
            --dark-bg: #121212;
            --light-bg: #1e1e2f;
            --text-color: #fff;
            --muted-text: #ccc;
        }

        body {
            background-color: var(--dark-bg);
            color: var(--text-color);
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            transition: background-image 2s ease-in-out;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: -1;
        }

        header {
            background: linear-gradient(to right, var(--bmw-blue), var(--bmw-red));
            color: white;
            padding: 2rem 1rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            z-index: 0;
        }

        header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0;
            letter-spacing: 1px;
        }

        header p {
            font-size: 1.2rem;
            margin-top: 0.5rem;
        }

        .logo {
            position: absolute;
            top: 1rem;
            left: 1rem;
            width: 80px;
            height: 80px;
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/4/44/BMW.svg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin: 0;
            z-index: 10;
        }

        .container-fluid {
            padding: 2rem 1rem;
            position: relative;
            z-index: 0;
        }

        .card {
            background-color: rgba(30, 30, 47, 0.9);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
            border: none;
            overflow: hidden;
            height: 100%;
        }

        .card:hover {
            transform: scale(1.03);
        }

        .card-img-top {
            height: 160px;
            object-fit: cover;
            width: 100%;
        }

        .card-body {
            padding: 1rem;
        }

        .card-title {
            color: var(--bmw-blue);
            font-weight: bold;
            font-size: 1.1rem;
        }

        .card-text {
            color: var(--muted-text);
            font-size: 0.9rem;
        }

        .btn-bmw {
            background-color: var(--bmw-blue);
            color: white;
            border: none;
            font-weight: bold;
            border-radius: 5px;
            padding: 0.5rem 1rem;
            cursor: pointer;
        }

        .btn-bmw:hover {
            background-color: #003b66;
        }

        footer {
            background-color: rgba(30, 30, 47, 0.9);
            color: var(--muted-text);
            text-align: center;
            padding: 1rem;
            margin-top: 2rem;
            position: relative;
            z-index: 0;
        }

        .theme-toggle {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            background-color: var(--bmw-blue);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            z-index: 1000;
        }

        .background-wave {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background: url('https://svgwave.ir/api/generate?color=var(--bmw-blue)&height=100') repeat-x;
            background-size: cover;
            z-index: -18;
        }

        .detail-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 1rem;
            background-color: rgba(18, 18, 18, 0.9);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
        }

        .detail-image {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .detail-title {
            color: var(--bmw-blue);
            margin-bottom: 1rem;
        }

        .detail-section {
            margin-bottom: 1.5rem;
        }

        .detail-section h3 {
            color: var(--bmw-red);
            margin-bottom: 0.5rem;
        }

        .steps-list {
            padding-right: 1.5rem;
        }

        .back-button {
            margin-top: 2rem;
        }

        .llm-response-area {
            background-color: rgba(42, 42, 61, 0.9);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1.5rem;
            border: 1px solid #3a3a50;
        }

        .llm-response-area h4 {
            color: var(--bmw-blue);
            margin-bottom: 0.75rem;
        }

        .llm-response-area p {
            color: var(--text-color);
            white-space: pre-wrap;
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--bmw-blue);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .moving-text-banner {
            background-color: rgba(0, 87, 146, 0.8);
            color: white;
            padding: 0.5rem 0;
            overflow: hidden;
            white-space: nowrap;
            position: relative;
            margin-top: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .moving-text-content {
            display: inline-block;
            padding-left: 100%;
            animation: marquee 20s linear infinite;
        }

        @keyframes marquee {
            0% { transform: translateX(0%); }
            100% { transform: translateX(-100%); }
        }

        .side-nav {
            position: fixed;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 999;
        }

        .side-nav .btn-nav {
            background-color: rgba(0, 87, 146, 0.8);
            color: white;
            border: none;
            padding: 0.75rem 0.5rem;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            text-decoration: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease, transform 0.2s ease;
            width: 100px;
        }

        .side-nav .btn-nav:hover {
            background-color: #003b66;
            transform: translateX(-5px);
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8rem;
            }
            .logo {
                width: 60px;
                height: 60px;
                top: 0.5rem;
                left: 0.5rem;
            }
            .card-img-top {
                height: 120px;
            }
            .card-body {
                padding: 0.75rem;
            }
            .card-title {
                font-size: 1rem;
            }
            .card-text {
                font-size: 0.8rem;
            }
            .side-nav {
                flex-direction: row;
                width: 100%;
                bottom: 0;
                top: auto;
                left: 0;
                right: 0;
                transform: translateY(0);
                justify-content: space-around;
                padding: 0.5rem;
                background-color: rgba(30, 30, 47, 0.95);
                border-top: 1px solid #3a3a50;
            }
            .side-nav .btn-nav {
                width: auto;
                padding: 0.5rem;
                font-size: 0.8rem;
            }
            .theme-toggle {
                bottom: 4.5rem;
            }
        }
        /* أنماط إضافية للقوائم المنسدلة */
        .form-select {
            background-color: rgba(255, 255, 255, 0.2); /* خلفية القائمة المحددة */
            color: var(--text-color); /* لون النص للقائمة المحددة */
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .form-select:disabled {
            background-color: rgba(255, 255, 255, 0.1);
            opacity: 0.5;
        }
        /* أنماط خيارات القائمة المنسدلة عند الفتح */
        .form-select option {
            background-color: #1a202c !important; /* خلفية داكنة للخيارات */
            color: #e2e8f0 !important; /* نص فاتح للخيارات */
        }
    </style>
</head>
<body>

    <div id="homePage">
        <header class="position-relative">
            <div class="logo"></div>
            <h1>AQ///BMW Coding Platform</h1>
            <p>online ai bmw coding Assistance</p>
            <div class="d-flex justify-content-center mt-3">
                <button class="btn-bmw me-2" onclick="scrollToActivations()">استعراض التفعيلات</button>
                <button class="btn-bmw" onclick="scrollToLearningActivations()">تعلم المزيد</button>
            </div>
            <div class="background-wave"></div>
        </header>

        <div class="moving-text-banner">
            <div class="moving-text-content">
                <p class="moving-text">
                </p>شرح خطوات التفعيل باذكاء الصناعي للمشتركين
            </div>
        </div>

        <main class="container-fluid mt-5">
            <h2 class="text-center text-white mb-4">اختيار السيارة</h2>
            <div class="row mb-4">
                <div class="col-md-4 mb-3">
                    <label for="model-select" class="form-label">سلسلة BMW</label>
                    <select id="model-select" class="form-select" dir="rtl">
                        <option value="">اختر السلسلة</option>
                        </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="year-select" class="form-label">سنة الإنتاج</label>
                    <select id="year-select" class="form-select" dir="rtl" disabled>
                        <option value="">اختر السنة</option>
                        </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="generation-select" class="form-label">الجيل</label>
                    <select id="generation-select" class="form-select" dir="rtl" disabled>
                        <option value="">اختر الجيل</option>
                        </select>
                </div>
            </div>
            <div class="text-center text-white mb-4" id="activationsCounter"></div>

            <h2 class="text-center text-white mb-4 mt-5">لمحة عن التعديلات</h2>
            <div class="row" id="activationsGrid">
                </div>

            <h2 class="text-center text-white mb-4 mt-5" id="learningActivationsSection">التفعيلات التعليمية</h2>
            <div class="row" id="learningGrid">
                </div>
        </main>

        <footer>
            &copy; 2025 AQ///BMW - جميع الحقوق محفوظة
            <a href="https://api.whatsapp.com/send?phone=972528180757" target="_blank">لتواصل معنا</a>
        </footer>
    </div>

    <div id="detailPage" style="display: none;">
        <header class="position-relative">
            <div class="logo"></div>
            <h1 id="detailPageTitle">تفعيل BMW</h1>
            <p>تفاصيل التفعيل</p>
            <div class="background-wave"></div>
        </header>

        <div class="detail-container">
            <img id="detailImage" class="detail-image" src="" alt="صورة التفعيل">
            <h2 id="detailTitle" class="detail-title"></h2>
            
            <div class="detail-section">
                <h3>الوصف</h3>
                <p id="detailDescription"></p>
            </div>
            
            <div class="detail-section">
                <h3>الوحدة (ECU)</h3>
                <p id="detailEcu"></p>
            </div>
            
            <div class="detail-section">
                <h3>خطوات التفعيل</h3>
                <ol id="detailSteps" class="steps-list"></ol>
            </div>

            <div class="d-flex justify-content-around mt-4 mb-3">
                <button class="btn-bmw me-2" onclick="handleSimplifiedExplanation()">شرح مبسط ✨</button>
                <button class="btn-bmw" onclick="handleActivationMethod()">طريقة التفعيل ✨</button>
            </div>

            <div id="llmResponseArea" class="llm-response-area" style="display: none;">
                <div class="loading-spinner" id="llmLoadingSpinner"></div>
                <h4 id="llmResponseTitle"></h4>
                <p id="llmResponseContent"></p>
            </div>
            
            <button class="btn-bmw back-button" onclick="goBack()">العودة إلى القائمة</button>
        </div>

        <footer>
            &copy; 2025 AQ///BMW - جميع الحقوق محفوظة
        </footer>
    </div>

    <nav class="side-nav">
        <a href="index.html" class="btn-nav">الرئيسية</a>
        <a href="index2.html" class="btn-nav">صفحة 2</a>
        <a href="index3.html" class="btn-nav">صفحة 3</a>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Webhook URL (from HomePage.tsx)
        const WEBHOOK_URL = "https://trigger.macrodroid.com/9519b967-983a-4878-a3c7-7d9560ffa0f7/bmw";
        const GEMINI_API_KEY = "AIzaSyAoXHtK_NHPQkuJlvFR6UNzHL-aZ2hzutk";

        // Data from HomePage.tsx, now integrated directly into JavaScript
        const allActivationsData = [
            { id: 1, title: "Trunk Closing via Interior Button", image_url: "https://storage.obdeleven.com/parse/3ecd529aff7d0ab6637e6f34563cd46f_oca_picture.jpg", year: "2017-2023", description: "إغلاق صندوق السيارة (الشنطة) باستخدام الزر الداخلي في مقصورة الركاب، مما يوفر راحة إضافية.", ecu: "BDC_BODY", category: "راحة" },
            { id: 2, title: "Wiper Cycle Completion", image_url: "https://storage.obdeleven.com/parse/750ddf869ed2d7d450c54a3739ff3c77_oca_picture.jpg", year: "2017-2023", description: "يضمن هذا التفعيل إكمال دورة مساحات الزجاج الأمامي حتى لو تم إيقاف تشغيل الإشعال.", ecu: "FEM_BODY", category: "ميزات" },
            { id: 3, title: "Ignition OFF when Exiting", image_url: "https://storage.obdeleven.com/parse/9059670dcf1745502608bbd3d3d62ee7_oca_picture.jpg", year: "2017-2023", description: "يقوم بإيقاف تشغيل الإشعال تلقائيًا عند مغادرة السيارة، مما يوفر الطاقة ويضيف للراحة.", ecu: "CAS", category: "راحة" },
            { id: 4, title: "Electronics OFF when Exiting", image_url: "https://storage.obdeleven.com/parse/008fdc80d60b3edeb200ef8fc36e000c_oca_picture.jpg", year: "2017-2023", description: "يضمن هذا التفعيل إيقاف تشغيل جميع الأنظمة الإلكترونية عند مغادرة السيارة لتجنب استنزاف البطارية.", ecu: "FEM_BODY", category: "طاقة" },
            { id: 5, title: "Comfort Operation via Door Lock", image_url: "https://storage.obdeleven.com/parse/ed76f27597313454a659aa2bb09c457b_oca_picture.jpg", year: "2017-2023", description: "يسمح هذا التفعيل بالتحكم المريح في النوافذ وفتحة السقف عبر قفل الباب.", ecu: "FEM_BODY", category: "راحة" },
            { id: 6, title: "Start/Stop Default Setting", image_url: "https://storage.obdeleven.com/parse/1ef7a9393adb9d197d0327c34cda0130_oca_picture.jpg", year: "2017-2023", description: "يمكنك ضبط الإعداد الافتراضي لوظيفة Start/Stop لتناسب تفضيلاتك.", ecu: "DME", category: "أداء" },
            { id: 7, title: "Comfort Operation via Key Fob", image_url: "https://storage.obdeleven.com/parse/e311254b0aa70298eed3d3173c86999e_oca_picture.jpg", year: "2017-2023", description: "يمكنك فتح وإغلاق النوافذ وفتحة السقف عن بعد باستخدام مفتاح السيارة.", ecu: "FEM_BODY", category: "راحة" },
            { id: 8, title: "Headlight Washer System", image_url: "https://storage.obdeleven.com/parse/f11600475ca1f96df6bc167604cee481_oca_picture.jpg", year: "2017-2023", description: "تحكم في نظام غسل المصابيح الأمامية لضمان رؤية واضحة في جميع الأوقات.", ecu: "FRM", category: "إضاءة" },
            { id: 9, title: "Date Display in OBC", image_url: "https://storage.obdeleven.com/parse/42a6762d2d30269f435b1b9eb1f566df_oca_picture.jpg", year: "2017-2023", description: "تفعيل عرض التاريخ في شاشة الكمبيوتر الخاص بالسيارة (OBC).", ecu: "KOMBI", category: "عرض" },
            { id: 10, title: "Comfort Mirrors", image_url: "https://storage.obdeleven.com/parse/67b7fc7999c8eb8358e958db1431c533_oca_picture.jpg", year: "2017-2023", description: "طي المرايا الجانبية تلقائيًا عند قفل السيارة لزيادة الراحة.", ecu: "FEM_BODY", category: "راحة" },
            { id: 11, title: "Side Mirrors Unfold Threshold", image_url: "https://storage.obdeleven.com/parse/1c846e136e99453f0610eb1f5f8b0449_oca_picture.jpg", year: "2017-2023", description: "ضبط سرعة فتح المرايا الجانبية بعد فتح قفل السيارة.", ecu: "FEM_BODY", category: "راحة" },
            { id: 12, title: "Sunroof Delay for Comfort Opening", image_url: "https://storage.obdeleven.com/parse/ff54ed21bc373b5f667bf7d2f0da0afd_oca_picture.jpg", year: "2017-2023", description: "ضبط تأخير فتحة السقف لفتحها بالكامل بشكل مريح بعد الضغط لفترة طويلة.", ecu: "JBBF", category: "راحة" },
            { id: 13, title: "5 Times Comfort Turn Signals", image_url: "https://storage.obdeleven.com/parse/0e66d343c0e35fd1b560772027d43d62_oca_picture.jpg", year: "2020-2024", description: "تفعيل إشارة الانعطاف المريحة لتومض 5 مرات بدلاً من 3.", ecu: "BDC_BODY", category: "إضاءة" },
            { id: 14, title: "M Logo Startup Animation", image_url: "https://storage.obdeleven.com/parse/c6084ab451c88bc8ef157eb3c16c83d8_oca_picture.jpg", year: "2020-2024", description: "تغيير رسوم بدء التشغيل في لوحة العدادات إلى شعار M Performance.", ecu: "HU_NBT", category: "عرض" },
            { id: 15, title: "M View Style Cluster", image_url: "https://storage.obdeleven.com/parse/f8030b56910a732fe26c7d2fc3a6e2a9_oca_picture.jpg", year: "2020-2024", description: "تفعيل نمط عرض M View في لوحة العدادات للحصول على مظهر رياضي.", ecu: "KOMBI", category: "عرض" },
            { id: 16, title: "Default Driving Mode", image_url: "https://storage.obdeleven.com/parse/a29fd63d2f5ac00386477960dd2cb340_oca_picture.jpg", year: "2020-2024", description: "ضبط وضع القيادة الافتراضي عند بدء تشغيل السيارة (مثال: Sport, Comfort).", ecu: "DME", category: "أداء" },
            { id: 17, title: "Horn on Secure", image_url: "https://storage.obdeleven.com/parse/ec3ea21397f01a38cfacfec8a45f86e0_oca_picture.jpg", year: "2020-2024", description: "تفعيل صوت البوق عند قفل السيارة لتأكيد الإغلاق الآمن.", ecu: "BDC_BODY", category: "أمان" },
            { id: 18, title: "TPMS Pressure and Temperature Display", image_url: "https://storage.obdeleven.com/parse/750b6938e0867d44071bbc032182c8cd_oca_picture.jpg", year: "2020-2024", description: "عرض ضغط ودرجة حرارة الإطارات في نظام TPMS مباشرة على الشاشة.", ecu: "HU_NBT", category: "عرض" },
            { id: 19, title: "iDrive Warnings", image_url: "https://storage.obdeleven.com/parse/66b0c574cd714768234e1a7a15d798cb_oca_picture.jpg", year: "2020-2024", description: "تخصيص أو إلغاء تنشيط التحذيرات المختلفة التي تظهر في نظام iDrive.", ecu: "HU_NBT", category: "ميزات" },
            { id: 20, title: "Front Fog Lights w/ High Beams", image_url: "https://storage.obdeleven.com/parse/a06b85fa78830e85946ef8354f02a95c_oca_picture.jpg", year: "2020-2024", description: "تفعيل الأضواء الكاشفة الأمامية للعمل مع الأضواء العالية.", ecu: "FEM_BODY", category: "إضاءة" },
            { id: 21, title: "Front Fog Lights w/ Parking Lights", image_url: "https://storage.obdeleven.com/parse/d5b143538118c4617d57ca691c004a75_oca_picture.jpg", year: "2020-2024", description: "تفعيل الأضواء الكاشفة الأمامية للعمل مع أضواء الوقوف.", ecu: "FEM_BODY", category: "إضاءة" },
            { id: 22, title: "Sport+ Mode", image_url: "https://storage.obdeleven.com/parse/c75546901cd815e8400b4c9e57c8fbda_oca_picture.jpg", year: "2020-2024", description: "تفعيل وضع القيادة Sport+ لتعزيز الأداء الرياضي للسيارة.", ecu: "DME", category: "أداء" },
            { id: 23, title: "X-View Display", image_url: "https://storage.obdeleven.com/parse/95a01cce6a9a4153c2482bbf90f114c9_oca_picture.jpg", year: "2020-2024", description: "تفعيل شاشة X-View التي تعرض معلومات إضافية حول السيارة (خاصة لمركبات X-series).", ecu: "HU_NBT", category: "عرض" },
            { id: 24, title: "Tire Pressure Display in Dashboard", image_url: "https://storage.obdeleven.com/parse/0834629027df2df27c0cadcf82a7331c_oca_picture.jpg", year: "2020-2024", description: "عرض ضغط ودرجة حرارة الإطارات في نظام TPMS مباشرة على الشاشة.", ecu: "HU_NBT", category: "عرض" },
            { id: 25, title: "Speedometer Scale Display", image_url: "https://storage.obdeleven.com/parse/7ce0f6abb9b268656316bc71ee153735_oca_picture.jpg", year: "2020-2024", description: "تفعيل عرض مقياس السرعة الرقمي في لوحة العدادات.", ecu: "KOMBI", category: "عرض" },
            { id: 26, title: "Alpina Style Display", image_url: "https://storage.obdeleven.com/parse/c873e490b1314a701f9bf13f0d73450d_oca_picture.jpg", year: "2020-2024", description: "تغيير تصميم لوحة العدادات إلى نمط Alpina المميز.", ecu: "KOMBI", category: "تخصيص" },
            { id: 27, title: "RLS Sensitivity", image_url: "https://storage.obdeleven.com/parse/2e9a187ad3e4975457c828d32b265d00_oca_picture.jpg", year: "2020-2024", description: "ضبط حساسية مستشعر المطر/الضوء (RLS) للتحكم في المساحات والإضاءة التلقائية.", ecu: "FRM", category: "حساسات" },
            { id: 28, title: "Seats Heating/Cooling Memory", image_url: "https://storage.obdeleven.com/parse/3bc5584b31e29dafb299a32a307548c1_oca_picture.jpg", year: "2020-2024", description: "تفعيل ذاكرة إعدادات تدفئة/تبريد المقاعد للحفاظ على تفضيلاتك.", ecu: "FEM_BODY", category: "راحة" },
            { id: 29, title: "Self Locking Time", image_url: "https://storage.obdeleven.com/parse/017f0cfdfafb6470f1d675974345b4b9_oca_picture.jpg", year: "2020-2024", description: "ضبط وقت القفل التلقائي للأبواب بعد فتحها وعدم دخول السيارة.", ecu: "FEM_BODY", category: "أمان" },
            { id: 30, title: "Power Front Windows Safety", image_url: "https://storage.obdeleven.com/parse/2605b25bfe3bf986a09a12dd6ccbafe2_oca_picture.jpg", year: "2020-2024", description: "تحسين ميزة السلامة للنوافذ الأمامية الكهربائية.", ecu: "FEM_BODY", category: "أمان" },
            { id: 31, title: "Emergency Braking Lights", image_url: "https://storage.obdeleven.com/parse/b550b5057a30ee8204ffd16ec8a730e9_oca_picture.jpg", year: "2020-2024", description: "تفعيل وميض أضواء الفرامل بقوة عند الفرملة المفاجئة لتنبيه السائقين الآخرين.", ecu: "FEM_BODY", category: "أمان" },
            { id: 32, title: "LED License Plate Lights", image_url: "https://storage.obdeleven.com/parse/be7c9596369c14bf9a35bce7a9634dff_oca_picture.jpg", year: "2020-2024", description: "تعديل إعدادات أضواء لوحة الترخيص LED.", ecu: "FEM_BODY", category: "إضاءة" },
            { id: 33, title: "Assisted Driving View", image_url: "https://storage.obdeleven.com/parse/164733e1175a7eab139864fbfd94e301_oca_picture.jpg", year: "2020-2024", description: "تفعيل عرض المساعدة في القيادة على الشاشة.", ecu: "HU_NBT", category: "قيادة" },
            { id: 34, title: "Acoustic Unlock Confirmation", image_url: "https://storage.obdeleven.com/parse/daad8bd4bd769adee75ba9f287b93766_oca_picture.jpg", year: "2020-2024", description: "تفعيل صوت تأكيد الفتح عند فتح قفل السيارة.", ecu: "BDC_BODY", category: "أمان" },
            { id: 35, title: "Automatic Lane Change", image_url: "https://storage.obdeleven.com/parse/fcd9a3378aa7aa47880fbcd7704588d5_oca_picture.jpg", year: "2020-2024", description: "تفعيل ميزة تغيير المسار التلقائي (يتطلب أنظمة مساعدة السائق المتقدمة).", ecu: "KOMBI", category: "قيادة" },
            { id: 36, title: "Bower & Wilkins Audio", image_url: "https://storage.obdeleven.com/parse/3acc77e1efe3590de5374403c43c7431_oca_picture.jpg", year: "2020-2024", description: "تفعيل إعدادات الصوت المحيطي من Bower & Wilkins (إذا كانت السيارة مجهزة بالنظام).", ecu: "RAM", category: "صوت" },
            { id: 37, title: "12V Battery Registration", image_url: "https://storage.obdeleven.com/parse/9caeb45c0000578cee2c94f4dc644983_oca_picture.jpg", year: "2020-2024", description: "تسجيل البطارية الجديدة 12V في نظام السيارة بعد استبدالها.", ecu: "JBBF", category: "صيانة" },
            { id: 38, title: "Engine Sound Menu", image_url: "https://storage.obdeleven.com/parse/a28d870764ebd97ea21cce79475e45cf_oca_picture.jpg", year: "2020-2024", description: "تفعيل قائمة للتحكم في صوت المحرك الاصطناعي (ASD).", ecu: "ASD", category: "أداء" },
            { id: 39, title: "Instrument Cluster Logo", image_url: "https://storage.obdeleven.com/parse/9281fcbd489723b44ffb99ea3f40e912_oca_picture.jpg", year: "2020-2024", description: "تغيير شعار بدء التشغيل في لوحة العدادات إلى شعار مخصص.", ecu: "KOMBI", category: "تخصيص" },
            { id: 40, title: "Automatic Steering Wheel Heating", image_url: "https://storage.obdeleven.com/parse/fa73e81d4d099184693965f006cedf88_oca_picture.jpg", year: "2020-2024", description: "تفعيل تدفئة عجلة القيادة تلقائيًا بناءً على درجة الحرارة.", ecu: "SZL", category: "راحة" },
            { id: 41, title: "Ambient Lighting Instead of Bronze", image_url: "https://storage.obdeleven.com/parse/2f4d0c62ee132453ff0bced6d80618c8_oca_picture.jpg", year: "2020-2024", description: "تغيير لون الإضاءة المحيطية الافتراضي من البرونزي إلى خيار آخر.", ecu: "BDC_BODY", category: "إضاءة" },
            { id: 42, title: "Ambient Color Instead of Bronze", image_url: "https://storage.obdeleven.com/parse/26e104be19815c2325202b469119bac7_oca_picture.jpg", year: "2020-2024", description: "تغيير لون الإضاءة المحيطية الافتراضي من البرونزي إلى لون آخر.", ecu: "BDC_BODY", category: "إضاءة" },
            { id: 43, title: "Rain Closing", image_url: "https://storage.obdeleven.com/parse/36d4dc3fa8e848c0d6a2f74f26733a39_oca_picture.jpg", year: "2020-2024", description: "تفعيل إغلاق النوافذ وفتحة السقف تلقائيًا عند استشعار المطر.", ecu: "FEM_BODY", category: "راحة" },
            { id: 44, title: "Scandinavian DRLs", image_url: "https://storage.obdeleven.com/parse/8722d3c8cc595754444c10f2b88896c9_oca_picture.jpg", year: "2020-2024", description: "تفعيل أضواء القيادة النهارية الاسكندنافية (DRLs).", ecu: "FRM", category: "إضاءة" },
            { id: 45, title: "M View Cluster Logo", image_url: "https://storage.obdeleven.com/parse/8b5fe8386d999b366f513f18496d7230_oca_picture.jpg", year: "2020-2024", description: "تغيير شعار لوحة العدادات إلى شعار M View.", ecu: "KOMBI", category: "عرض" },
            { id: 46, title: "Rear Seat Belts Reminder Menu", image_url: "https://storage.obdeleven.com/parse/5c692f5330b674a618b7afa3604add04_oca_picture.jpg", year: "2020-2024", description: "تفعيل قائمة لتذكير أحزمة الأمان للمقاعد الخلفية.", ecu: "KOMBI", category: "أمان" },
            { id: 47, title: "Active Sound Design Deactivation", image_url: "https://storage.obdeleven.com/parse/159a4022221dacd99df5556dead2d5bb_oca_picture.jpg", year: "2020-2024", description: "إلغاء تنشيط نظام تصميم الصوت النشط (ASD) لتقليل الصوت الصناعي للمحرك.", ecu: "ASD", category: "أداء" },
            { id: 48, title: "ECO PRO Coasting Mode", image_url: "https://storage.obdeleven.com/parse/40b747b342a0e62a4cb41e010cbd8b3c_oca_picture.jpg", year: "2020-2024", description: "تفعيل وضع الانطلاق الحر (Coasting) في وضع ECO PRO لتحسين كفاءة الوقود.", ecu: "DME", category: "أداء" },
            { id: 49, title: "Comfort+ Mode", image_url: "https://storage.obdeleven.com/parse/c4e5ef27ac26d52bc4fc01c0be79da6e_oca_picture.jpg", year: "2020-2024", description: "تفعيل وضع Comfort+ للحصول على قيادة أكثر راحة ونعومة.", ecu: "ICM", category: "راحة" },
            { id: 50, title: "Brake Lights Test", image_url: "https://storage.obdeleven.com/parse/79c83239c057fff25d0ffc0290e44f83_oca_picture.jpg", year: "2020-2024", description: "إجراء اختبار لأضواء الفرامل للتأكد من عملها بشكل صحيح.", ecu: "FEM_BODY", category: "فحص" },
            { id: 51, title: "Reversing Lights Test", image_url: "https://storage.obdeleven.com/parse/44ecec72499c9f1c68a9bbd6381c4577_oca_picture.jpg", year: "2020-2024", description: "إجراء اختبار لأضواء الرجوع للخلف للتأكد من عملها بشكل صحيح.", ecu: "FEM_BODY", category: "فحص" },
            { id: 52, title: "Windscreen Washer Pump Test", image_url: "https://storage.obdeleven.com/parse/98e61f5539a545cfede9847ac8f79d3a_oca_picture.jpg", year: "2020-2024", description: "إجراء اختبار لمضخة غسيل الزجاج الأمامي.", ecu: "FEM_BODY", category: "فحص" },
            { id: 53, title: "Radiator Blind Opening and Closing ", image_url: "https://storage.obdeleven.com/parse/191ec48271def6879338a979daa8a382_oca_picture.jpg", year: "2020-2024", description: "التحكم في فتح وإغلاق ستائر المبرد (Radiator Blinds).", ecu: "DME", category: "أداء" },
            { id: 54, title: "Steering Wheel Vibration Test", image_url: "https://storage.obdeleven.com/parse/05671bc403200ee80861cd573d2f049b_oca_picture.jpg", year: "2020-2024", description: "إجراء اختبار لاهتزاز عجلة القيادة (خاص بالأنظمة التي تدعم هذه الميزة).", ecu: "ICM", category: "فحص" },
            { id: 55, title: "Engine Fan Test", image_url: "https://storage.obdeleven.com/parse/695fd1be4b24dfd3b5222090d16f520a_oca_picture.jpg", year: "2020-2024", description: "إجراء اختبار لمروحة المحرك للتأكد من عملها الصحيح.", ecu: "DME", category: "فحص" },
            { id: 56, title: "Horn Test", image_url: "https://storage.obdeleven.com/parse/25004774a9c5fa633d3660c65c76ece0_oca_picture.jpg", year: "2020-2024", description: "إجراء اختبار لبوق السيارة.", ecu: "BDC_BODY", category: "فحص" },
            { id: 57, title: "Rear Fog Lights Test", image_url: "https://storage.obdeleven.com/parse/91efcacfe9b197171c786f359ca28c20_oca_picture.jpg", year: "2020-2024", description: "إجراء اختبار لأضواء الضباب الخلفية.", ecu: "FEM_BODY", category: "فحص" },
            { id: 58, title: "Headlights Check", image_url: "https://storage.obdeleven.com/parse/f0169c9a66aeaa3564a54473b65c9039_oca_picture.jpg", year: "2020-2024", description: "فحص شامل لأضواء المصابيح الأمامية.", ecu: "FRM", category: "فحص" },
            { id: 59, title: "Instrument Cluster Lights Test", image_url: "https://storage.obdeleven.com/parse/06b677511a8683a43e283a03c7bb6f50_oca_picture.jpg", year: "2020-2024", description: "إجراء اختبار لأضواء لوحة العدادات.", ecu: "KOMBI", category: "فحص" },
            { id: 60, title: "SOS Emergency Call System", image_url: "https://storage.obdeleven.com/parse/63c12ebda4e28525f79ced7e43280430_oca_picture.jpg", year: "2020-2024", description: "تفعيل أو تعديل نظام الاتصال الطارئ SOS.", ecu: "TELEMATIK", category: "أمان" },
            { id: 61, title: "Brake Fluid Reset", image_url: "https://storage.obdeleven.com/parse/b54f3a14eb0d261c6fcb72bb2ca76507_oca_picture.jpg", year: "2019", description: "إعادة ضبط مؤشر سائل الفرامل بعد الصيانة.", ecu: "DSC", category: "صيانة" },
            { id: 62, title: "Engine Oil Reset", image_url: "https://storage.obdeleven.com/parse/a4928157214fe0311f38de63854ff1cd_oca_picture.jpg", year: "2019", description: "إعادة ضبط مؤشر زيت المحرك بعد تغيير الزيت.", ecu: "DME", category: "صيانة" },
            { id: 63, title: "Front Brake Pads Reset", image_url: "https://storage.obdeleven.com/parse/e404e4d551c5f55da70f2fbaa034f0ee_oca_picture.jpg", year: "2019", description: "إعادة ضبط مؤشر وسادات الفرامل الأمامية بعد استبدالها.", ecu: "DSC", category: "صيانة" },
            { id: 64, title: "Rear Brake Pads Reset", image_url: "https://storage.obdeleven.com/parse/daa9554fbda4dbb659e12c6dcd6a5e86_oca_picture.jpg", year: "2019", description: "إعادة ضبط مؤشر وسادات الفرامل الخلفية بعد استبدالها.", ecu: "DSC", category: "صيانة" },
            { id: 65, title: "Vehicle Check Reset", image_url: "https://storage.obdeleven.com/parse/b7ce4b499333c3aeb4fcaa413683e3c0_oca_picture.jpg", year: "2019", description: "إعادة ضبط مؤشر فحص السيارة الدوري.", ecu: "KOMBI", category: "صيانة" },
            { id: 66, title: "Sport Displays", image_url: "https://storage.obdeleven.com/parse/503c60d9d59f49ee5fe65487b9e80038_oca_picture.jpg", year: "2019", description: "تفعيل عرض شاشات الأداء الرياضي (Sport Displays) في نظام iDrive.", ecu: "HU_NBT", category: "عرض" },
            { id: 67, title: "Video in Motion", image_url: "https://storage.obdeleven.com/parse/edf807d20d731007d9bf380b7c28e886_oca_picture.jpg", year: "2019", description: "تفعيل إمكانية تشغيل الفيديو أثناء حركة السيارة.", ecu: "HU_NBT", category: "ترفيه" },
            { id: 68, title: "Tow Hitch Display", image_url: "https://storage.obdeleven.com/parse/4aeff12b62f3fbace5e8613285232f68_oca_picture.jpg", year: "2019", description: "تفعيل عرض معلومات وصلة الجر في شاشة iDrive.", ecu: "TRM", category: "ميزات" },
            { id: 69, title: "Comfort Operation via CA", image_url: "https://storage.obdeleven.com/parse/16ac1f179b8edc90c11b1fefbb611c33_oca_picture.jpg", year: "2019", description: "تفعيل التحكم المريح عبر الوصول المريح (Comfort Access) للنوافذ وفتحة السقف.", ecu: "FEM_BODY", category: "راحة" },
            { id: 70, title: "Sport Displays Color", image_url: "https://storage.obdeleven.com/parse/45f535c8fd75cdbea9656621b9a3a7c9_oca_picture.jpg", year: "2019", description: "تغيير لون شاشات الأداء الرياضي.", ecu: "HU_NBT", category: "تخصيص" },
            { id: 71, title: "Maximum Volume", image_url: "https://storage.obdeleven.com/parse/d4a8c7d87179af7df7f76789b3d6ae91_oca_picture.jpg", year: "2019", description: "ضبط مستوى الصوت الأقصى لنظام الصوت.", ecu: "RAM", category: "صوت" },
            { id: 72, title: "NBT EVO Menu Style", image_url: "https://storage.obdeleven.com/parse/265862d2f2fdcd1ae6689152080e9f8d_oca_picture.jpg", year: "2019", description: "تغيير نمط قائمة نظام iDrive إلى نمط NBT EVO الأحدث.", ecu: "HU_NBT", category: "تخصيص" }
        ];

        const learningActivationsData = [
            { series: "F10/F11", ecu: "SZL", description: "تمكين مبدلات السرعة (Paddle Shifters) لعجلة القيادة، وهو مفيد بشكل خاص للسيارات التي تم تحديثها بهذه الميزة.", steps: ["1. الدخول إلى وحدة SZL (وحدة مركز التوجيه).", "2. البحث عن المعلمة 'Lenkrad_Schaltpaddles'.", "3. تغيير القيمة إلى 'aktiv' (نشط).", "4. حفظ التغييرات وتشفير الوحدة."], title: "تمكين مبدلات السرعة (Paddle Shifters)", image_url: "https://storage.obdeleven.com/parse/750ddf869ed2d7d450c54a3739ff3c77_oca_picture.jpg" },
            { series: "G-Series", ecu: "BDC_BODY", description: "إغلاق صندوق السيارة (الشنطة) باستخدام الزر الداخلي في مقصورة الركاب، مما يوفر راحة إضافية.", steps: ["1. الدخول إلى وحدة BDC_BODY (وحدة تحكم الجسم).", "2. البحث عن الوظيفة المتعلقة بإغلاق الصندوق من الداخل.", "3. تفعيل هذه الوظيفة.", "4. حفظ التغييرات."], title: "إغلاق صندوق السيارة بالزر الداخلي", image_url: "https://storage.obdeleven.com/parse/3ecd529aff7d0ab6637e6f34563cd46f_oca_picture.jpg" },
            { series: "F30/F32", ecu: "HU_NBT", description: "تفعيل عرض السرعة الرقمية في لوحة العدادات للحصول على قراءة دقيقة للسرعة.", steps: ["1. الدخول إلى وحدة HU_NBT (وحدة المعلومات والترفيه).", "2. البحث عن خيار عرض السرعة الرقمية.", "3. تفعيله وحفظ الإعدادات."], title: "عرض السرعة الرقمية في لوحة العدادات", image_url: "https://storage.obdeleven.com/parse/7ce0f6abb9b268656316bc71ee153735_oca_picture.jpg" },
            { series: "G05/G07", ecu: "KOMBI", description: "تغيير رسوم بدء التشغيل في لوحة العدادات إلى شعار M Performance.", steps: ["1. الدخول إلى وحدة KOMBI (لوحة العدادات).", "2. البحث عن إعداد رسوم بدء التشغيل.", "3. تحديد شعار M Performance.", "4. حفظ التغييرات وإعادة تشغيل iDrive."], title: "رسوم بدء تشغيل شعار M", image_url: "https://storage.obdeleven.com/parse/c6084ab451c88bc8ef157eb3c16c83d8_oca_picture.jpg" },
            { series: "F-Series", ecu: "FEM_BODY", description: "تفعيل إغلاق النوافذ وفتحة السقف تلقائيًا عند استشعار المطر.", steps: ["1. الدخول إلى وحدة FEM_BODY.", "2. البحث عن 'Rain Closing' أو ما يعادلها.", "3. تفعيل الوظيفة."], title: "إغلاق النوافذ مع المطر", image_url: "https://storage.obdeleven.com/parse/36d4dc3fa8e848c0d6a2f74f26733a39_oca_picture.jpg" },
            { series: "All", ecu: "غير محدد", description: "معلومات عامة حول كيفية تحديث خرائط نظام الملاحة في سيارات BMW.", steps: ["1. قم بتنزيل ملفات الخرائط من مصدر موثوق.", "2. انقل الملفات إلى محرك أقراص USB مهيأ بشكل صحيح.", "3. أدخل محرك USB في منفذ USB بالسيارة.", "4. اتبع التعليمات التي تظهر على شاشة iDrive لإكمال التحديث."], title: "تحديث خرائط الملاحة", image_url: "https://placehold.co/200x200/005792/ffffff?text=خرائط+الملاحة" }
        ];

        // بيانات ModelSelector (المضمنة هنا من bmw_models.json و bmw_years_generations.json)
        const bmwModels = [
            { "value": "F01", "text": "7 Series (F01/F02/F03/F04)" },
            { "value": "F10", "text": "5 Series (F10/F11/F07/F18)" },
            // ... أضف جميع موديلات BMW من bmw_models.json هنا
        ];

        const bmwYearsGenerations = {
            "F01": {
                "years": [
                    { "value": "2008", "text": "2008-2015", "generations": [{ "value": "F01", "text": "F01/F02/F03/F04" }] }
                ]
            },
            "F10": {
                "years": [
                    { "value": "2010", "text": "2010-2016", "generations": [{ "value": "F10", "text": "F10/F11/F07/F18" }] }
                ]
            },
            // ... أضف جميع بيانات السنوات والأجيال من bmw_years_generations.json هنا
        };

        // متغيرات الحالة (تم استبدال React useState بها)
        let selectedModel = '';
        let selectedModelName = '';
        let selectedYear = '';
        let selectedYearText = '';
        let selectedGeneration = '';
        let selectedGenerationText = '';
        let currentDetailedActivation = null; // لتخزين التفعيل الحالي المعروض في صفحة التفاصيل

        // --- وظائف ModelSelector (مدمجة هنا) ---
        function populateModels() {
            const selectElement = document.getElementById('model-select');
            bmwModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.value;
                option.textContent = model.text;
                selectElement.appendChild(option);
            });
        }

        function handleModelChange() {
            const selectElement = document.getElementById('model-select');
            selectedModel = selectElement.value;
            selectedModelName = selectElement.options[selectElement.selectedIndex].text;

            const yearSelect = document.getElementById('year-select');
            const generationSelect = document.getElementById('generation-select');
            yearSelect.innerHTML = '<option value="">اختر السنة</option>';
            generationSelect.innerHTML = '<option value="">اختر الجيل</option>';
            generationSelect.disabled = true;

            if (selectedModel) {
                const modelData = bmwYearsGenerations[selectedModel];
                if (modelData) {
                    modelData.years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year.value;
                        option.textContent = year.text;
                        yearSelect.appendChild(option);
                    });
                    yearSelect.disabled = false;
                }
            } else {
                yearSelect.disabled = true;
            }
            updateActivationsDisplay();
        }

        function handleYearChange() {
            const selectElement = document.getElementById('year-select');
            selectedYear = selectElement.value;
            selectedYearText = selectElement.options[selectElement.selectedIndex].text;

            const generationSelect = document.getElementById('generation-select');
            generationSelect.innerHTML = '<option value="">اختر الجيل</option>';

            if (selectedModel && selectedYear) {
                const modelData = bmwYearsGenerations[selectedModel];
                if (modelData) {
                    const yearData = modelData.years.find(year => year.value === selectedYear);
                    if (yearData) {
                        yearData.generations.forEach(gen => {
                            const option = document.createElement('option');
                            option.value = gen.value;
                            option.textContent = gen.text;
                            generationSelect.appendChild(option);
                        });
                        generationSelect.disabled = false;
                    }
                }
            } else {
                generationSelect.disabled = true;
            }
            updateActivationsDisplay();
        }

        function handleGenerationChange() {
            const selectElement = document.getElementById('generation-select');
            selectedGeneration = selectElement.value;
            selectedGenerationText = selectElement.options[selectElement.selectedIndex].text;
            updateActivationsDisplay();
        }

        function getFilteredActivations() {
            if (!selectedModel || !selectedYear || !selectedGeneration) {
                return [];
            }
            const activationGroup = bmwActivations.find(
                item => item.model === selectedModel &&
                        item.year === selectedYear &&
                        item.generation === selectedGeneration
            );
            return activationGroup ? activationGroup.activations : [];
        }

        function updateActivationsDisplay() {
            const activationsGrid = document.getElementById('activationsGrid');
            const activationsCounter = document.getElementById('activationsCounter');
            activationsGrid.innerHTML = ''; // Clear previous cards

            const filtered = getFilteredActivations();

            if (filtered.length > 0) {
                activationsCounter.innerHTML = `<span class="inline-block bg-blue-500 text-white px-4 py-2 rounded-full text-sm font-bold">
                                                    ${filtered.length} تفعيل متاح لـ ${selectedModelName} ${selectedYearText} ${selectedGenerationText}
                                                </span>`;
                filtered.forEach(item => {
                    const col = document.createElement('div');
                    col.className = 'col-md-3 col-sm-6 mb-4'; /* Bootstrap grid classes */

                    const card = document.createElement('div');
                    card.className = 'card';

                    const cardImg = document.createElement('img');
                    cardImg.className = 'card-img-top';
                    cardImg.src = item.image_url || 'https://placehold.co/160x120/cccccc/000000?text=صورة+غير+متوفرة';
                    cardImg.alt = item.title;
                    cardImg.onerror = () => {
                        cardImg.src = 'https://placehold.co/160x120/cccccc/000000?text=صورة+غير+متوفرة';
                    };
                    card.appendChild(cardImg);

                    const cardBody = document.createElement('div');
                    cardBody.className = 'card-body';

                    const title = document.createElement('h5');
                    title.className = 'card-title';
                    title.textContent = item.title;
                    cardBody.appendChild(title);

                    const description = document.createElement('p');
                    description.className = 'card-text';
                    description.textContent = item.description || "لا يوجد وصف متاح.";
                    cardBody.appendChild(description);

                    if (item.price) {
                        const priceSpan = document.createElement('span');
                        priceSpan.className = 'font-bold text-success'; // Bootstrap success for green
                        priceSpan.textContent = `${item.price} ₪`;
                        cardBody.appendChild(priceSpan);
                    }

                    const btn = document.createElement('button');
                    btn.className = 'btn btn-primary mt-3 w-100'; // Bootstrap button classes
                    btn.textContent = 'عرض التفاصيل';
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        // لفتح صفحة التفاصيل نحتاج id تفعيل.
                        // يجب أن يحتوي allActivationsData على id
                        const activation = allActivationsData.find(act => act.title === item.title); // البحث بالاسم
                        if (activation) {
                            showDetail(activation.id);
                        } else {
                            console.error("Activation not found for detail view:", item.title);
                        }
                    };
                    cardBody.appendChild(btn);

                    card.appendChild(cardBody);
                    col.appendChild(card);
                    activationsGrid.appendChild(col);
                });
            } else {
                activationsCounter.textContent = '';
                activationsGrid.innerHTML = '<p class="text-center text-muted">لا توجد تفعيلات متاحة لهذه السيارة المختارة. الرجاء اختيار موديل، سنة، وجيل.</p>';
            }
        }


        // عرض بطاقات تعلم التفعيلات في الصفحة الرئيسية (من البيانات المدمجة)
        function generateLearningCards() {
            const grid = document.getElementById('learningGrid');
            grid.innerHTML = '';

            if (learningActivationsData.length === 0) {
                grid.innerHTML = '<p class="text-center text-muted">لا توجد مواد تعليمية لعرضها حالياً.</p>';
                return;
            }

            learningActivationsData.forEach(item => {
                const col = document.createElement('div');
                col.className = 'col-md-3 col-sm-6 mb-4';

                const card = document.createElement('div');
                card.className = 'card';

                const cardImg = document.createElement('img');
                cardImg.className = 'card-img-top';
                cardImg.src = item.imageUrl || 'https://placehold.co/160x120/cccccc/000000?text=صورة+غير+متوفرة';
                cardImg.alt = item.title;
                cardImg.onerror = () => {
                    cardImg.src = 'https://placehold.co/160x120/cccccc/000000?text=صورة+غير+متوفرة';
                };
                card.appendChild(cardImg);

                const cardBody = document.createElement('div');
                cardBody.className = 'card-body';

                const title = document.createElement('h5');
                title.className = 'card-title';
                title.textContent = item.title;
                cardBody.appendChild(title);

                const description = document.createElement('p');
                description.className = 'card-text';
                description.textContent = item.description;
                cardBody.appendChild(description);

                card.appendChild(cardBody);
                col.appendChild(card);
                grid.appendChild(col);
            });
        }

        // --- وظائف صفحة التفاصيل LLM و Webhook (مدمجة هنا) ---
        function showLoadingSpinner() {
            document.getElementById('llmResponseArea').style.display = 'block';
            document.getElementById('llmLoadingSpinner').style.display = 'block';
            document.getElementById('llmResponseTitle').textContent = '';
            document.getElementById('llmResponseContent').textContent = '';
        }

        function hideLoadingSpinner() {
            document.getElementById('llmLoadingSpinner').style.display = 'none';
        }

        function displayLLMResponse(title, content) {
            document.getElementById('llmResponseTitle').textContent = title;
            document.getElementById('llmResponseContent').textContent = content;
            document.getElementById('llmResponseArea').style.display = 'block';
        }

        async function callGeminiAPI(prompt, title) {
            showLoadingSpinner();
            try {
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    displayLLMResponse(title, text);
                } else {
                    displayLLMResponse(title, 'عذرًا، لم أتمكن من الحصول على استجابة. يرجى المحاولة مرة أخرى.');
                    console.error('هيكل استجابة Gemini API غير متوقع:', result);
                }
            } catch (error) {
                displayLLMResponse(title, 'حدث خطأ أثناء الاتصال بـ Gemini API. يرجى التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى.');
                console.error('خطأ في استدعاء Gemini API:', error);
            } finally {
                hideLoadingSpinner();
            }
        }

        async function handleSimplifiedExplanation() {
            if (!currentActivation) {
                displayLLMResponse('خطأ', 'يرجى تحديد تفعيل أولاً.');
                return;
            }
            const prompt = `اشرح تفعيل BMW التالي بطريقة مبسطة ومختصرة: "${currentActivation.title}". هذا التفعيل مخصص لسيارات BMW موديل ${currentActivation.year || 'غير معروف'}.`;
            await callGeminiAPI(prompt, 'شرح مبسط للتفعيل');
        }

        async function handleActivationMethod() {
            if (!currentActivation) {
                displayLLMResponse('خطأ', 'يرجى تحديد تفعيل أولاً.');
                return;
            }

            const matchingLearningItem = learningActivationsData.find(learnItem =>
                learnItem.title && currentActivation.title && learnItem.title.toLowerCase() === currentActivation.title.toLowerCase()
            );

            let prompt;
            if (matchingLearningItem && matchingLearningItem.description) {
                prompt = `بناءً على الوصف التالي لتفعيل BMW: "${matchingLearningItem.description}"، يرجى تقديم خطوات تفعيل مفصلة وواضحة لهذا التفعيل. ركز على الخطوات العملية التي يمكن للمستخدم اتباعها.`;
            } else {
                prompt = `يرجى تقديم خطوات تفعيل مفصلة وواضحة لتفعيل BMW بعنوان "${currentActivation.title}" (موديل ${currentActivation.year || 'غير معروف'}).`;
            }
            
            await callGeminiAPI(prompt, 'طريقة التفعيل');
        }

        // --- وظائف نموذج الاتصال (مدمجة هنا) ---
        let contactName = '';
        let contactEmail = '';
        let contactPhone = '';
        let contactMessage = '';

        function setContactFormMessage() {
            const messageField = document.getElementById('contact-message');
            if (selectedModel && selectedYear && selectedGeneration) {
                messageField.value = `أود الاستفسار عن تفعيل لسيارة: BMW ${selectedModelName} (موديل ${selectedYearText}, جيل ${selectedGenerationText}).`;
            } else {
                messageField.value = '';
            }
        }

        async function handleSubmitContactForm(event) {
            event.preventDefault();

            contactName = document.getElementById('contact-name').value;
            contactEmail = document.getElementById('contact-email').value;
            contactPhone = document.getElementById('contact-phone').value;
            contactMessage = document.getElementById('contact-message').value;

            const queryParams = new URLSearchParams({
                name: contactName,
                email: contactEmail,
                phone: contactPhone,
                message: contactMessage,
                car_model: selectedModelName || "لم يتم اختيار سيارة",
                car_year: selectedYearText || "لم يتم اختيار سيارة",
                car_generation: selectedGenerationText || "لم يتم اختيار سيارة"
            }).toString();

            const finalWebhookUrl = `${WEBHOOK_URL}?${queryParams}`;

            try {
                const response = await fetch(finalWebhookUrl, {
                    method: 'GET',
                });

                if (response.ok) {
                    alert('تم إرسال رسالتك بنجاح!');
                    document.getElementById('contact-name').value = '';
                    document.getElementById('contact-email').value = '';
                    document.getElementById('contact-phone').value = '';
                    setContactFormMessage(); // Reset message to default
                } else {
                    alert(`حدث خطأ أثناء إرسال الرسالة. رمز الخطأ: ${response.status}. الرجاء المحاولة مرة أخرى.`);
                    console.error('Webhook error:', response.statusText, response.status);
                }
            } catch (error) {
                alert('حدث خطأ في الاتصال. الرجاء التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى.');
                console.error('Network error:', error);
            }
        }

        // --- وظائف تهيئة الصفحة عند التحميل (DOMContentLoaded) ---
        document.addEventListener('DOMContentLoaded', function() {
            // ربط أحداث تغيير القوائم المنسدلة
            document.getElementById('model-select').addEventListener('change', handleModelChange);
            document.getElementById('year-select').addEventListener('change', handleYearChange);
            document.getElementById('generation-select').addEventListener('change', handleGenerationChange);

            // ربط حدث إرسال نموذج الاتصال
            document.getElementById('contactForm').addEventListener('submit', handleSubmitContactForm);

            populateModels(); // ملء قائمة الموديلات عند التحميل
            generateCards(); // إنشاء بطاقات التفعيلات (البيانات الثابتة)
            generateLearningCards(); // إنشاء بطاقات تعلم التفعيلات (البيانات المدمجة)
            startBackgroundRotation(); // بدء تدوير الخلفيات
        });

        // --- وظائف الخلفية الديناميكية (من HomePage.tsx) ---
        const backgroundImages = [
            'https://imagedelivery.net/c2SKP8Bk0ZKw6UDgeeIlbw/55b954f0-c771-45c2-6519-dbe3ec1ceb00/public',
            'https://wallpapers.com/images/high/bmw-m8-4k-0iajmo8ncu3jaog8.webp',
            'https://wallpapers.com/images/high/bmw-m4-cs-racetrack-4k-wallpaper-4z115206x15p7f7i.webp',
            'https://wallpapers.com/images/high/bmw-m4-coupe-4k-wallpaper-l7q2j5d86214l1j2.webp',
            'https://wallpapers.com/images/high/bmw-m4-gts-4k-wallpaper-c98x5e85x167b7p3.webp',
            'https://wallpapers.com/images/high/bmw-m2-coupe-4k-wallpaper-h52q330d0z595844.webp'
        ];
        let currentBackgroundIndex = 0; // ابدأ من 0 ليكون متسقًا مع JS Array

        function changeBackground() {
            document.body.style.backgroundImage = `url('${backgroundImages[currentBackgroundIndex]}')`;
            currentBackgroundIndex = (currentBackgroundIndex + 1) % backgroundImages.length;
        }

        function startBackgroundRotation() {
            changeBackground(); // Set initial background
            setInterval(changeBackground, 10000); // Change every 10 seconds
        }
    </script>

</body>
</html>
