<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>AQ///BMW - تفعيلات BMW الحديثة</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
    :root {
      --bmw-blue: #005792;
      --bmw-red: #d63031;
      --bmw-white: #ffffff;
      --bmw-gray: #f4f4f4;
      --dark-bg: #121212;
      --light-bg: #1e1e2f;
      --text-color: #fff;
      --muted-text: #ccc;
    }

    body {
      background-color: var(--dark-bg);
      color: var(--text-color);
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      /* Background image styling */
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
      background-attachment: fixed; /* Fix background while scrolling */
      transition: background-image 2s ease-in-out; /* Smooth transition for background image change */
    }

    /* Overlay to make text readable over dynamic background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7); /* Slightly more transparent dark overlay */
      z-index: -1;
    }

    header {
      background: linear-gradient(to right, var(--bmw-blue), var(--bmw-red));
      color: white;
      padding: 2rem 1rem;
      text-align: center;
      position: relative;
      overflow: hidden;
      z-index: 0; /* Ensure header is above overlay */
    }

    header h1 {
      font-size: 2.5rem;
      font-weight: bold;
      margin: 0;
      letter-spacing: 1px;
    }

    header p {
      font-size: 1.2rem;
      margin-top: 0.5rem;
    }

    .logo {
      position: absolute; /* Position absolutely */
      top: 1rem; /* 1rem from the top */
      left: 1rem; /* 1rem from the left */
      width: 80px; /* Smaller width for better fit */
      height: 80px; /* Smaller height */
      background-image: url('https://upload.wikimedia.org/wikipedia/commons/4/44/BMW.svg');
      background-size: contain;
      background-repeat: no-repeat; /* No repeat for a single logo */
      background-position: center;
      margin: 0; /* Remove default margin */
      z-index: 10; /* Ensure logo is above other header content */
    }

    .container-fluid {
      padding: 2rem 1rem;
      position: relative; /* Ensure content is above overlay */
      z-index: 0;
    }

    .card {
      background-color: rgba(30, 30, 47, 0.9); /* Slightly transparent light-bg */
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease;
      border: none;
      overflow: hidden;
      height: 100%; /* Ensure cards take full height in their grid cell */
    }

    .card:hover {
      transform: scale(1.03);
    }

    .card-img-top {
      height: 160px; /* Smaller image height */
      object-fit: cover;
      width: 100%;
    }

    .card-body {
      padding: 1rem; /* Reduced padding */
    }

    .card-title {
      color: var(--bmw-blue);
      font-weight: bold;
      font-size: 1.1rem; /* Slightly smaller font size */
    }

    .card-text {
      color: var(--muted-text);
      font-size: 0.9rem; /* Slightly smaller font size */
    }

    .btn-bmw {
      background-color: var(--bmw-blue);
      color: white;
      border: none;
      font-weight: bold;
      border-radius: 5px;
      padding: 0.5rem 1rem;
      cursor: pointer;
    }

    .btn-bmw:hover {
      background-color: #003b66;
    }

    footer {
      background-color: rgba(30, 30, 47, 0.9); /* Slightly transparent light-bg */
      color: var(--muted-text);
      text-align: center;
      padding: 1rem;
      margin-top: 2rem;
      position: relative; /* Ensure footer is above overlay */
      z-index: 0;
    }

    .theme-toggle {
      position: fixed;
      bottom: 1rem;
      left: 1rem;
      background-color: var(--bmw-blue);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      font-weight: bold;
      border-radius: 6px;
      cursor: pointer;
      z-index: 1000;
    }

    .background-wave {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 100px;
      background: url('https://svgwave.ir/api/generate?color=var(--bmw-blue)&height=100') repeat-x;
      background-size: cover;
      z-index: -18; /* Keep it behind other elements */
    }

    /* صفحة التفاصيل */
    .detail-container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 1rem;
      background-color: rgba(18, 18, 18, 0.9); /* Transparent dark-bg for detail page */
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      position: relative;
      z-index: 1; /* Ensure detail page is above overlay */
    }

    .detail-image {
      width: 100%;
      max-height: 400px;
      object-fit: contain;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }

    .detail-title {
      color: var(--bmw-blue);
      margin-bottom: 1rem;
    }

    .detail-section {
      margin-bottom: 1.5rem;
    }

    .detail-section h3 {
      color: var(--bmw-red);
      margin-bottom: 0.5rem;
    }

    .steps-list {
      padding-right: 1.5rem;
    }

    .back-button {
      margin-top: 2rem;
    }

    .llm-response-area {
      background-color: rgba(42, 42, 61, 0.9); /* Transparent version of #2a2a3d */
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1.5rem;
      border: 1px solid #3a3a50;
    }

    .llm-response-area h4 {
      color: var(--bmw-blue);
      margin-bottom: 0.75rem;
    }

    .llm-response-area p {
      color: var(--text-color);
      white-space: pre-wrap; /* للحفاظ على تنسيق النص من LLM */
    }

    .loading-spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid var(--bmw-blue);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
      display: none; /* مخفي افتراضياً */
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Moving Text Banner */
    .moving-text-banner {
      background-color: rgba(0, 87, 146, 0.8); /* Semi-transparent BMW blue */
      color: white;
      padding: 0.5rem 0;
      overflow: hidden;
      white-space: nowrap;
      position: relative;
      margin-top: 1rem; /* Space below header buttons */
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .moving-text-content {
      display: inline-block;
      padding-left: 100%; /* Start off-screen */
      animation: marquee 20s linear infinite; /* Adjust duration for speed */
    }

    @keyframes marquee {
      0% { transform: translateX(0%); }
      100% { transform: translateX(-100%); }
    }

    /* Side Navigation Buttons */
    .side-nav {
      position: fixed;
      right: 1rem; /* Position on the right side */
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 10px; /* Space between buttons */
      z-index: 999; /* Ensure it's above most content */
    }

    .side-nav .btn-nav {
      background-color: rgba(0, 87, 146, 0.8); /* Semi-transparent BMW blue */
      color: white;
      border: none;
      padding: 0.75rem 0.5rem; /* Adjust padding for vertical buttons */
      border-radius: 8px;
      font-weight: bold;
      text-align: center;
      text-decoration: none; /* Remove underline for links */
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      transition: background-color 0.3s ease, transform 0.2s ease;
      width: 100px; /* Fixed width for consistency */
    }

    .side-nav .btn-nav:hover {
      background-color: #003b66;
      transform: translateX(-5px); /* Slight hover effect */
    }

    @media (max-width: 768px) {
      header h1 {
        font-size: 1.8rem;
      }
      .logo {
        width: 60px; /* Smaller logo on mobile */
        height: 60px;
        top: 0.5rem;
        left: 0.5rem;
      }
      .card-img-top {
        height: 120px; /* Even smaller image height on mobile */
      }
      .card-body {
        padding: 0.75rem; /* Further reduced padding on mobile */
      }
      .card-title {
        font-size: 1rem;
      }
      .card-text {
        font-size: 0.8rem;
      }
      .side-nav {
        flex-direction: row; /* Horizontal layout on mobile */
        width: 100%;
        bottom: 0;
        top: auto;
        left: 0;
        right: 0;
        transform: translateY(0);
        justify-content: space-around;
        padding: 0.5rem;
        background-color: rgba(30, 30, 47, 0.95); /* Solid background for mobile nav */
        border-top: 1px solid #3a3a50;
      }
      .side-nav .btn-nav {
        width: auto; /* Auto width for horizontal layout */
        padding: 0.5rem;
        font-size: 0.8rem;
      }
      .theme-toggle {
        bottom: 4.5rem; /* Adjust position to avoid overlapping mobile nav */
      }
    }
  
        .form-select {
            background-color: rgba(255, 255, 255, 0.2); /* خلفية القائمة المحددة */
            color: var(--text-color); /* لون النص للقائمة المحددة */
            border: 1px solid rgba(255, 255, 255, 0.3);
            /* إضافة هذه لتجاوز مشاكل بعض المتصفحات */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .form-select:disabled {
            background-color: rgba(255, 255, 255, 0.1);
            opacity: 0.5;
        }
        /* أنماط خيارات القائمة المنسدلة عند الفتح */
        .form-select option {
            background-color: #1a202c !important; /* خلفية داكنة للخيارات */
            color: #e2e8f0 !important; /* نص فاتح للخيارات */
        }
    </style>
</head>
<body>

    <div id="homePage">
        <header class="position-relative">
            <div class="logo"></div>
            <h1>AQ///BMW Coding Platform</h1>
            <p>online ai bmw coding Assistance</p>
            <div class="d-flex justify-content-center mt-3">
                <button class="btn-bmw me-2" onclick="scrollToActivations()">استعراض التفعيلات</button>
                <button class="btn-bmw" onclick="scrollToLearningActivations()">تعلم المزيد</button>
            </div>
            <div class="background-wave"></div>
        </header>

        <div class="moving-text-banner">
            <div class="moving-text-content">
                <p class="moving-text">
                </p>شرح خطوات التفعيل باذكاء الصناعي للمشتركين
            </div>
        </div>

        <main class="container-fluid mt-5">
            <h2 class="text-center text-white mb-4">اختيار السيارة</h2>
            <div class="row mb-4">
                <div class="col-md-4 mb-3">
                    <label for="model-select" class="form-label">سلسلة BMW</label>
                    <select id="model-select" class="form-select" dir="rtl"></select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="year-select" class="form-label">سنة الإنتاج</label>
                    <select id="year-select" class="form-select" dir="rtl" disabled></select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="generation-select" class="form-label">الجيل</label>
                    <select id="generation-select" class="form-select" dir="rtl" disabled></select>
                </div>
            </div>
            <div class="text-center text-white mb-4" id="activationsCounter"></div>

            <h2 class="text-center text-white mb-4 mt-5">لمحة عن التعديلات</h2>
            <div class="row" id="activationsGrid"></div>

            <h2 class="text-center text-white mb-4 mt-5" id="learningActivationsSection">التفعيلات التعليمية</h2>
            <div class="row" id="learningGrid"></div>

            <section id="contact-section" class="container-fluid mt-5 p-4 rounded" style="background-color: rgba(30, 30, 47, 0.9);">
                <h2 class="text-center text-white mb-4">تواصل معنا</h2>
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <form id="contactForm" class="row g-3">
                            <div class="col-md-6">
                                <label for="contact-name" class="form-label">الاسم الكامل</label>
                                <input type="text" class="form-control" id="contact-name" required>
                            </div>
                            <div class="col-md-6">
                                <label for="contact-email" class="form-label">البريد الإلكتروني</label>
                                <input type="email" class="form-control" id="contact-email" required>
                            </div>
                            <div class="col-12">
                                <label for="contact-phone" class="form-label">رقم الهاتف</label>
                                <input type="tel" class="form-control" id="contact-phone" required>
                            </div>
                            <div class="col-12">
                                <label for="contact-message" class="form-label">رسالتك</label>
                                <textarea class="form-control" id="contact-message" rows="5"></textarea>
                            </div>
                            <div class="col-12 text-center">
                                <button type="submit" class="btn btn-primary btn-lg mt-3">إرسال الرسالة</button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            &copy; 2025 AQ///BMW - جميع الحقوق محفوظة
            <a href="https://api.whatsapp.com/send?phone=972528180757" target="_blank">لتواصل معنا</a>
        </footer>
    </div>

    <div id="detailPage" style="display: none;">
        <header class="position-relative">
            <div class="logo"></div>
            <h1 id="detailPageTitle">تفعيل BMW</h1>
            <p>تفاصيل التفعيل</p>
            <div class="background-wave"></div>
        </header>

        <div class="detail-container">
            <img id="detailImage" class="detail-image" src="" alt="صورة التفعيل">
            <h2 id="detailTitle" class="detail-title"></h2>
            
            <div class="detail-section">
                <h3>الوصف</h3>
                <p id="detailDescription"></p>
            </div>
            
            <div class="detail-section">
                <h3>الوحدة (ECU)</h3>
                <p id="detailEcu"></p>
            </div>
            
            <div class="detail-section">
                <h3>خطوات التفعيل</h3>
                <ol id="detailSteps" class="steps-list"></ol>
            </div>

            <div class="d-flex justify-content-around mt-4 mb-3">
                <button class="btn-bmw me-2" onclick="handleSimplifiedExplanation()">شرح مبسط ✨</button>
                <button class="btn-bmw" onclick="handleActivationMethod()">طريقة التفعيل ✨</button>
            </div>

            <div id="llmResponseArea" class="llm-response-area" style="display: none;">
                <div class="loading-spinner" id="llmLoadingSpinner"></div>
                <h4 id="llmResponseTitle"></h4>
                <p id="llmResponseContent"></p>
            </div>
            
            <button class="btn-bmw back-button" onclick="goBack()">العودة إلى القائمة</button>
        </div>

        <footer>
            &copy; 2025 AQ///BMW - جميع الحقوق محفوظة
        </footer>
    </div>

    <nav class="side-nav">
        <a href="#homePage" class="btn-nav" onclick="goBack()">الرئيسية</a>
        <a href="#activationsGrid" class="btn-nav" onclick="scrollToActivations()">التفعيلات</a>
        <a href="#learningActivationsSection" class="btn-nav" onclick="scrollToLearningActivations()">الخدمات</a>
        <a href="#contact-section" class="btn-nav" onclick="document.getElementById('contact-section').scrollIntoView({ behavior: 'smooth' })">تواصل معنا</a>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Webhook URL
        const WEBHOOK_URL = "https://trigger.macrodroid.com/9519b967-983a-4878-a3c7-7d9560ffa0f7/bmw";
        const GEMINI_API_KEY = "AIzaSyAoXHtK_NHPQkuJlvFR6UNzHL-aZ2hzutk";

        // روابط ملفات JSON السحابية
        const BMW_MODELS_URL = "https://raw.githubusercontent.com/cctv-security/AQbimmer/refs/heads/main/src/data/bmw_models.json";
        const BMW_YEARS_GENERATIONS_URL = "https://raw.githubusercontent.com/cctv-security/AQbimmer/refs/heads/main/src/data/bmw_years_generations.json";
        const BMW_ACTIVATIONS_URL = "https://raw.githubusercontent.com/cctv-security/AQbimmer/refs/heads/main/src/data/bmw_activations.json";
        const CODINGS_ARABIC_URL = "https://raw.githubusercontent.com/cctv-security/AQbimmer/refs/heads/main/src/data/codings_arabic.json";
        const CODINGS_ENGLISH_URL = "https://raw.githubusercontent.com/cctv-security/AQbimmer/refs/heads/main/src/data/codings_english.json";

        // متغيرات لتخزين البيانات المجلوبة
        let bmwModels = [];
        let bmwYearsGenerations = {};
        let bmwActivations = [];
        let learningActivationsData = []; // ستملأ من codings_arabic_url

        // متغيرات الحالة (تم استبدال React useState بها)
        let selectedModel = '';
        let selectedModelName = '';
        let selectedYear = '';
        let selectedYearText = '';
        let selectedGeneration = '';
        let selectedGenerationText = '';
        let currentActivation = null; // لتخزين التفعيل الحالي المعروض في صفحة التفاصيل

        // --- وظائف جلب البيانات من GitHub Raw ---
        async function fetchJson(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} from ${url}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Failed to fetch JSON from ${url}:`, error);
                return null; // Handle error gracefully
            }
        }

        // --- وظائف ModelSelector (مدمجة هنا) ---
        function populateModels() {
            const selectElement = document.getElementById('model-select');
            selectElement.innerHTML = '<option value="">اختر السلسلة</option>'; // إعادة تعيين الخيارات
            bmwModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.value;
                option.textContent = model.text;
                selectElement.appendChild(option);
            });
        }

        function handleModelChange() {
            const selectElement = document.getElementById('model-select');
            selectedModel = selectElement.value;
            selectedModelName = selectElement.options[selectElement.selectedIndex].text;

            const yearSelect = document.getElementById('year-select');
            const generationSelect = document.getElementById('generation-select');
            yearSelect.innerHTML = '<option value="">اختر السنة</option>';
            generationSelect.innerHTML = '<option value="">اختر الجيل</option>';
            generationSelect.disabled = true;

            selectedYear = ''; // إعادة تعيين السنة
            selectedYearText = '';
            selectedGeneration = ''; // إعادة تعيين الجيل
            selectedGenerationText = '';

            if (selectedModel && bmwYearsGenerations[selectedModel]) {
                const modelData = bmwYearsGenerations[selectedModel];
                modelData.years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year.value;
                    option.textContent = year.text;
                    yearSelect.appendChild(option);
                });
                yearSelect.disabled = false;
            } else {
                yearSelect.disabled = true;
            }
            updateActivationsDisplay(); // تحديث عرض التفعيلات بعد تغيير الموديل
            setContactFormMessage(); // تحديث رسالة نموذج الاتصال
        }

        function handleYearChange() {
            const selectElement = document.getElementById('year-select');
            selectedYear = selectElement.value;
            selectedYearText = selectElement.options[selectElement.selectedIndex].text;

            const generationSelect = document.getElementById('generation-select');
            generationSelect.innerHTML = '<option value="">اختر الجيل</option>';

            selectedGeneration = ''; // إعادة تعيين الجيل
            selectedGenerationText = '';

            if (selectedModel && selectedYear && bmwYearsGenerations[selectedModel]) {
                const modelData = bmwYearsGenerations[selectedModel];
                const yearData = modelData.years.find(year => year.value === selectedYear);
                if (yearData) {
                    yearData.generations.forEach(gen => {
                        const option = document.createElement('option');
                        option.value = gen.value;
                        option.textContent = gen.text;
                        generationSelect.appendChild(option);
                    });
                    generationSelect.disabled = false;
                }
            } else {
                generationSelect.disabled = true;
            }
            updateActivationsDisplay(); // تحديث عرض التفعيلات بعد تغيير السنة
            setContactFormMessage(); // تحديث رسالة نموذج الاتصال
        }

        function handleGenerationChange() {
            const selectElement = document.getElementById('generation-select');
            selectedGeneration = selectElement.value;
            selectedGenerationText = selectElement.options[selectElement.selectedIndex].text;
            updateActivationsDisplay(); // تحديث عرض التفعيلات بعد تغيير الجيل
            setContactFormMessage(); // تحديث رسالة نموذج الاتصال
        }

        function getFilteredActivations() {
            if (!selectedModel || !selectedYear || !selectedGeneration) {
                return [];
            }
            // يجب أن يحتوي bmwActivations على هيكل يسمح بالبحث هذا
            const activationGroup = bmwActivations.find(
                item => item.model === selectedModel &&
                        item.year === selectedYear &&
                        item.generation === selectedGeneration
            );
            return activationGroup ? activationGroup.activations : [];
        }

        function updateActivationsDisplay() {
            const activationsGrid = document.getElementById('activationsGrid');
            const activationsCounter = document.getElementById('activationsCounter');
            activationsGrid.innerHTML = ''; // Clear previous cards

            const filtered = getFilteredActivations();

            if (filtered.length > 0) {
                activationsCounter.innerHTML = `<span class="inline-block bg-primary text-white px-4 py-2 rounded-full text-sm font-bold">
                                                    ${filtered.length} تفعيل متاح لـ ${selectedModelName} ${selectedYearText} ${selectedGenerationText}
                                                </span>`;
                filtered.forEach((item, index) => {
                    const col = document.createElement('div');
                    col.className = 'col-md-3 col-sm-6 mb-4'; /* Bootstrap grid classes */

                    const card = document.createElement('div');
                    card.className = 'card';

                    const cardImg = document.createElement('img');
                    cardImg.className = 'card-img-top';
                    cardImg.src = item.image_url || 'https://placehold.co/160x120/cccccc/000000?text=صورة+غير+متوفرة';
                    cardImg.alt = item.title;
                    cardImg.onerror = () => {
                        cardImg.src = 'https://placehold.co/160x120/cccccc/000000?text=صورة+غير+متوفرة';
                    };
                    card.appendChild(cardImg);

                    const cardBody = document.createElement('div');
                    cardBody.className = 'card-body';

                    const title = document.createElement('h5');
                    title.className = 'card-title';
                    title.textContent = item.title;
                    cardBody.appendChild(title);

                    const description = document.createElement('p');
                    description.className = 'card-text';
                    description.textContent = item.description || "لا يوجد وصف متاح.";
                    cardBody.appendChild(description);

                    if (item.price) {
                        const priceSpan = document.createElement('span');
                        priceSpan.className = 'fw-bold text-success'; // Bootstrap success for green
                        priceSpan.textContent = `${item.price} ₪`;
                        cardBody.appendChild(priceSpan);
                    }

                    const btn = document.createElement('button');
                    btn.className = 'btn btn-primary mt-3 w-100'; // Bootstrap button classes
                    btn.textContent = 'عرض التفاصيل';
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        // تأكد من أن 'id' متاح في بيانات التفعيل الأصلية أو قم بتوليده
                        // هنا نستخدم 'id' من العنصر المفلتر، بافتراض أنه موجود أو تم توليده
                        showDetail(item.id || `act-${index}`); 
                    };
                    cardBody.appendChild(btn);

                    card.appendChild(cardBody);
                    col.appendChild(card);
                    activationsGrid.appendChild(col);
                });
            } else {
                activationsCounter.textContent = '';
                activationsGrid.innerHTML = '<p class="text-center text-muted">لا توجد تفعيلات متاحة لهذه السيارة المختارة. الرجاء اختيار موديل، سنة، وجيل.</p>';
            }
        }

        // عرض بطاقات تعلم التفعيلات في الصفحة الرئيسية (من البيانات المدمجة)
        function generateLearningCards() {
            const grid = document.getElementById('learningGrid');
            grid.innerHTML = '';

            if (learningActivationsData.length === 0) {
                grid.innerHTML = '<p class="text-center text-muted">لا توجد مواد تعليمية لعرضها حالياً.</p>';
                return;
            }

            learningActivationsData.forEach(item => {
                const col = document.createElement('div');
                col.className = 'col-md-3 col-sm-6 mb-4';

                const card = document.createElement('div');
                card.className = 'card';

                const cardImg = document.createElement('img');
                cardImg.className = 'card-img-top';
                cardImg.src = item.imageUrl || 'https://placehold.co/160x120/cccccc/000000?text=صورة+غير+متوفرة';
                cardImg.alt = item.title;
                cardImg.onerror = () => {
                    cardImg.src = 'https://placehold.co/160x120/cccccc/000000?text=صورة+غير+متوفرة';
                };
                card.appendChild(cardImg);

                const cardBody = document.createElement('div');
                cardBody.className = 'card-body';

                const title = document.createElement('h5');
                title.className = 'card-title';
                title.textContent = item.title;
                cardBody.appendChild(title);

                const description = document.createElement('p');
                description.className = 'card-text';
                description.textContent = item.description;
                cardBody.appendChild(description);

                card.appendChild(cardBody);
                col.appendChild(card);
                grid.appendChild(col);
            });
        }

        // عرض صفحة التفاصيل (لتفعيلات BMW فقط)
        function showDetail(id) {
            // البحث في كل من allActivationsData و learningActivationsData
            let item = allActivationsData.find(act => act.id === id);
            if (!item) {
                // إذا لم يتم العثور عليه في allActivationsData، ابحث في learningActivationsData (قد تكون IDs مختلفة)
                item = learningActivationsData.find(learnAct => learnAct.id === id);
            }

            if (!item) {
                console.error('لم يتم العثور على التفعيل بالمعرف:', id);
                return;
            }
            currentActivation = item;
            
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('detailPage').style.display = 'block';
            
            document.getElementById('detailImage').src = item.image_url || item.imageUrl || 'https://placehold.co/400x250/cccccc/000000?text=صورة+غير+متوفرة';
            document.getElementById('detailImage').alt = item.title;
            document.getElementById('detailTitle').textContent = item.title;
            document.getElementById('detailDescription').textContent = item.description;
            document.getElementById('detailEcu').textContent = item.ecu || 'غير محدد'; // يمكن أن يكون غير محدد في بعض البيانات
            
            const stepsList = document.getElementById('detailSteps');
            stepsList.innerHTML = '';

            let stepsToDisplay = item.steps;

            if (!stepsToDisplay || stepsToDisplay.length === 0) {
                // محاولة البحث عن خطوات مطابقة في learningActivationsData بناءً على العنوان
                const matchingLearningItem = learningActivationsData.find(learnItem =>
                    learnItem.title && item.title && learnItem.title.toLowerCase() === item.title.toLowerCase()
                );

                if (matchingLearningItem && matchingLearningItem.steps && matchingLearningItem.steps.length > 0) {
                    stepsToDisplay = matchingLearningItem.steps;
                } else if (matchingLearningItem && matchingLearningItem.description) {
                    const descSteps = matchingLearningItem.description.split('. ').filter(s => s.trim() !== '');
                    if (descSteps.length > 0) {
                        stepsToDisplay = descSteps;
                    } else {
                        stepsToDisplay = ["لا تتوفر خطوات محددة لهذا التفعيل التعليمي، ولكن هذا هو وصفه العام: " + matchingLearningItem.description];
                    }
                } else {
                    stepsToDisplay = ["لا تتوفر خطوات تفعيل محددة لهذا البند."];
                }
            }
            
            stepsToDisplay.forEach(step => {
                const li = document.createElement('li');
                li.textContent = step;
                stepsList.appendChild(li);
            });
            
            document.getElementById('llmResponseArea').style.display = 'none';
            document.getElementById('llmResponseContent').textContent = '';
            document.getElementById('llmResponseTitle').textContent = '';
            
            window.scrollTo(0, 0);
        }

        function goBack() {
            document.getElementById('homePage').style.display = 'block';
            document.getElementById('detailPage').style.display = 'none';
            currentActivation = null;
            window.scrollTo(0, 0);
        }

        function scrollToActivations() {
            document.getElementById('activationsGrid').scrollIntoView({ behavior: 'smooth' });
        }

        function scrollToLearningActivations() {
            document.getElementById('learningActivationsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function showLoadingSpinner() {
            document.getElementById('llmResponseArea').style.display = 'block';
            document.getElementById('llmLoadingSpinner').style.display = 'block';
            document.getElementById('llmResponseTitle').textContent = '';
            document.getElementById('llmResponseContent').textContent = '';
        }

        function hideLoadingSpinner() {
            document.getElementById('llmLoadingSpinner').style.display = 'none';
        }

        function displayLLMResponse(title, content) {
            document.getElementById('llmResponseTitle').textContent = title;
            document.getElementById('llmResponseContent').textContent = content;
            document.getElementById('llmResponseArea').style.display = 'block';
        }

        async function callGeminiAPI(prompt, title) {
            showLoadingSpinner();
            try {
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    displayLLMResponse(title, text);
                } else {
                    displayLLMResponse(title, 'عذرًا، لم أتمكن من الحصول على استجابة. يرجى المحاولة مرة أخرى.');
                    console.error('هيكل استجابة Gemini API غير متوقع:', result);
                }
            } catch (error) {
                displayLLMResponse(title, 'حدث خطأ أثناء الاتصال بـ Gemini API. يرجى التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى.');
                console.error('خطأ في استدعاء Gemini API:', error);
            } finally {
                hideLoadingSpinner();
            }
        }

        async function handleSimplifiedExplanation() {
            if (!currentActivation) {
                displayLLMResponse('خطأ', 'يرجى تحديد تفعيل أولاً.');
                return;
            }
            const prompt = `اشرح تفعيل BMW التالي بطريقة مبسطة ومختصرة: "${currentActivation.title}". هذا التفعيل مخصص لسيارات BMW موديل ${currentActivation.year || 'غير معروف'}.`;
            await callGeminiAPI(prompt, 'شرح مبسط للتفعيل');
        }

        async function handleActivationMethod() {
            if (!currentActivation) {
                displayLLMResponse('خطأ', 'يرجى تحديد تفعيل أولاً.');
                return;
            }

            const matchingLearningItem = learningActivationsData.find(learnItem =>
                learnItem.title && currentActivation.title && learnItem.title.toLowerCase() === currentActivation.title.toLowerCase()
            );

            let prompt;
            if (matchingLearningItem && matchingLearningItem.description) {
                prompt = `بناءً على الوصف التالي لتفعيل BMW: "${matchingLearningItem.description}"، يرجى تقديم خطوات تفعيل مفصلة وواضحة لهذا التفعيل. ركز على الخطوات العملية التي يمكن للمستخدم اتباعها.`;
            } else {
                prompt = `يرجى تقديم خطوات تفعيل مفصلة وواضحة لتفعيل BMW بعنوان "${currentActivation.title}" (موديل ${currentActivation.year || 'غير معروف'}).`;
            }
            
            await callGeminiAPI(prompt, 'طريقة التفعيل');
        }

        // --- وظائف نموذج الاتصال (مدمجة هنا) ---
        let contactName = '';
        let contactEmail = '';
        let contactPhone = '';
        let contactMessage = '';

        function setContactFormMessage() {
            const messageField = document.getElementById('contact-message');
            // احتفظ بقيمة المستخدم إذا كتبها، وإلا فضع الافتراضي
            const currentMessage = messageField.value;
            let defaultMessage = '';
            if (selectedModel && selectedYear && selectedGeneration) {
                defaultMessage = `أود الاستفسار عن تفعيل لسيارة: BMW ${selectedModelName} (موديل ${selectedYearText}, جيل ${selectedGenerationText}).`;
            }
            
            // تحديث القيمة فقط إذا كانت الرسالة فارغة أو هي الرسالة الافتراضية السابقة
            if (currentMessage === '' || currentMessage.startsWith('أود الاستفسار عن تفعيل لسيارة:')) {
                messageField.value = defaultMessage;
            }
        }

        async function handleSubmitContactForm(event) {
            event.preventDefault();

            contactName = document.getElementById('contact-name').value;
            contactEmail = document.getElementById('contact-email').value;
            contactPhone = document.getElementById('contact-phone').value;
            contactMessage = document.getElementById('contact-message').value;

            const queryParams = new URLSearchParams({
                name: contactName,
                email: contactEmail,
                phone: contactPhone,
                message: contactMessage,
                car_model: selectedModelName || "لم يتم اختيار سيارة",
                car_year: selectedYearText || "لم يتم اختيار سيارة",
                car_generation: selectedGenerationText || "لم يتم اختيار سيارة"
            }).toString();

            const finalWebhookUrl = `${WEBHOOK_URL}?${queryParams}`;

            try {
                const response = await fetch(finalWebhookUrl, {
                    method: 'GET',
                });

                if (response.ok) {
                    alert('تم إرسال رسالتك بنجاح!');
                    document.getElementById('contact-name').value = '';
                    document.getElementById('contact-email').value = '';
                    document.getElementById('contact-phone').value = '';
                    // Reset message to default, allowing user to type again
                    document.getElementById('contact-message').value = ''; 
                    setContactFormMessage(); // This will put the default message back if car is selected
                } else {
                    alert(`حدث خطأ أثناء إرسال الرسالة. رمز الخطأ: ${response.status}. الرجاء المحاولة مرة أخرى.`);
                    console.error('Webhook error:', response.statusText, response.status);
                }
            } catch (error) {
                alert('حدث خطأ في الاتصال. الرجاء التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى.');
                console.error('Network error:', error);
            }
        }

        // --- وظائف تهيئة الصفحة عند التحميل (DOMContentLoaded) ---
        document.addEventListener('DOMContentLoaded', async function() {
            // جلب جميع ملفات JSON بالتوازي
            const [
                modelsData,
                yearsGenerationsData,
                activationsDataRemote,
                codingsArabicData,
                codingsEnglishData // ليس مطلوبًا حاليًا لكن يمكن جلبه
            ] = await Promise.all([
                fetchJson(BMW_MODELS_URL),
                fetchJson(BMW_YEARS_GENERATIONS_URL),
                fetchJson(BMW_ACTIVATIONS_URL),
                fetchJson(CODINGS_ARABIC_URL),
                fetchJson(CODINGS_ENGLISH_URL) // جلب هذا أيضاً
            ]);

            // التحقق من أن جميع البيانات تم جلبها بنجاح قبل المتابعة
            if (modelsData && yearsGenerationsData && activationsDataRemote && codingsArabicData) {
                bmwModels = modelsData;
                bmwYearsGenerations = yearsGenerationsData;
                
                // تنسيق بيانات التفعيلات عن بعد لتشمل ID و ImageUrl افتراضية إن لم تكن موجودة
                // وتضمين الوصف والخطوات من الكود الأصلي if available
                allActivationsData = activationsDataRemote.flatMap(group => 
                    group.activations.map((act, index) => ({
                        id: `remote-act-${group.model}-${group.year}-${group.generation}-${index}`, // توليد ID فريد
                        title: act.title,
                        description: act.description,
                        category: act.category,
                        price: act.price,
                        // توفير قيم افتراضية أو من البيانات الأصلية إذا لم تكن في JSON
                        image_url: act.image_url || 'https://placehold.co/160x120/cccccc/000000?text=صورة+غير+متوفرة',
                        ecu: act.ecu || 'غير محدد', 
                        year: group.year, // استخدام year من المجموعة الأم
                        steps: act.steps || [] // يمكن استكمالها لاحقاً من البيانات التعليمية
                    }))
                );

                // تنسيق بيانات التفعيلات التعليمية
                learningActivationsData = codingsArabicData.map((item, index) => {
                    let stepsContent = [];
                    if (item.steps && Array.isArray(item.steps)) {
                        stepsContent = item.steps;
                    } else if (item.content) {
                        stepsContent = item.content.split('\n').filter(step => step.trim() !== '');
                    } else if (item.description) {
                        stepsContent = item.description.split('. ').filter(step => step.trim() !== '');
                    } else {
                        stepsContent = ["لا تتوفر خطوات محددة لهذا البند التعليمي."];
                    }
                    return {
                        id: `learn-${item.series}-${index}`, // توليد ID فريد
                        title: item.title || "عنوان غير متوفر",
                        description: item.description || "لا يوجد وصف متاح لهذا التفعيل التعليمي.",
                        imageUrl: item.image_url || 'https://placehold.co/200x200/cccccc/000000?text=صورة+غير+متوفرة',
                        ecu: item.ecu || 'غير محدد',
                        series: item.series, // حفظ السلسلة للبحث لاحقاً
                        steps: stepsContent
                    };
                });


                // ربط أحداث تغيير القوائم المنسدلة
                document.getElementById('model-select').addEventListener('change', handleModelChange);
                document.getElementById('year-select').addEventListener('change', handleYearChange);
                document.getElementById('generation-select').addEventListener('change', handleGenerationChange);

                // ربط حدث إرسال نموذج الاتصال
                document.getElementById('contactForm').addEventListener('submit', handleSubmitContactForm);
                document.getElementById('contact-message').addEventListener('input', setContactFormMessage); // لتمكين المستخدم من الكتابة

                populateModels(); // ملء قائمة الموديلات عند التحميل
                generateCards(); // إنشاء بطاقات التفعيلات الثابتة
                generateLearningCards(); // إنشاء بطاقات تعلم التفعيلات (البيانات المدمجة)
                startBackgroundRotation(); // بدء تدوير الخلفيات
            } else {
                console.error("Failed to load essential data. Please check network and JSON URLs.");
                // يمكن هنا عرض رسالة خطأ للمستخدم في واجهة المستخدم
            }
        });

        // --- وظائف الخلفية الديناميكية ---
        const backgroundImages = [
            'https://imagedelivery.net/c2SKP8Bk0ZKw6UDgeeIlbw/55b954f0-c771-45c2-6519-dbe3ec1ceb00/public',
            'https://wallpapers.com/images/high/bmw-m8-4k-0iajmo8ncu3jaog8.webp',
            'https://wallpapers.com/images/high/bmw-m4-cs-racetrack-4k-wallpaper-4z115206x15p7f7i.webp',
            'https://wallpapers.com/images/high/bmw-m4-coupe-4k-wallpaper-l7q2j5d86214l1j2.webp',
            'https://wallpapers.com/images/high/bmw-m4-gts-4k-wallpaper-c98x5e85x167b7p3.webp',
            'https://wallpapers.com/images/high/bmw-m2-coupe-4k-wallpaper-h52q330d0z595844.webp'
        ];
        let currentBackgroundIndex = 0; // ابدأ من 0 ليكون متسقًا مع JS Array

        function changeBackground() {
            document.body.style.backgroundImage = `url('${backgroundImages[currentBackgroundIndex]}')`;
            currentBackgroundIndex = (currentBackgroundIndex + 1) % backgroundImages.length;
        }

        function startBackgroundRotation() {
            changeBackground(); // Set initial background
            setInterval(changeBackground, 10000); // Change every 10 seconds
        }
    </script>

</body>
</html>
